// https://dbdiagram.io/d/strimq-67aef4cf263d6cf9a025fe16
enum tier {
  free_trial [note: 'Free Trial tier will get their infras data wiped after 30 days']
  bronze
  silver
  gold
  platinum [note: 'Platinum tier will get their own dedicated infra']
}


Table tenants {
  id UUID [pk]
  name varchar(255)
  domain varchar(255)
  tier tier
  infras_id UUID [ref: > tenant_infras.id]

  created_at timestamp
  updated_at timestamp
}

Table tenant_infras {
  id UUID [pk]
  name varchar(255)
  kafka_brokers "varchar(255)[]"
  schema_registry_url varchar(255)
  kafka_connect_url varchar(255)
  kms_key varchar(255)

  created_at timestamp
  updated_at timestamp
}

Table sources {
  id UUID [pk]
  tenant_id UUID [ref: > tenants.id]
  name varchar(255)
  
  created_at timestamp
  updated_at timestamp
}

Table source_tags {
  source_id UUID [ref: > sources.id]
  key varchar(255)
  value varchar(255)
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (source_id, key) [pk]
  }
}

Table source_app_configs {
  source_id UUID [ref: > sources.id]
  key varchar(255)
  value varchar(255)
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (source_id, key) [pk]
  }
}

Table source_app_tables {
  id UUID [pk]
  source_id UUID [ref: > sources.id]
  db_name varchar(255)
  schema_name varchar(255)
  table_name varchar(255)
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (source_id, db_name, schema_name, table_name) [unique]
  }
}

Table source_app_columns {
  table_id UUID [ref: > source_app_tables.id]
  column_name varchar(255)
  column_type varchar(255)
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (table_id, column_name) [pk]
  }
}

Table source_kc_connectors {
  id UUID [pk]
  source_id UUID [ref: > sources.id]
  name varchar(255) [not null, unique]
  connector_class varchar(255)
  version varchar(255)
  
  created_at timestamp
  updated_at timestamp
}

Table source_kc_configs {
  kc_id UUID [ref: > source_kc_connectors.id]
  key varchar(255)
  value text
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (kc_id, key) [pk]
  }
}

Table sinks {
  id UUID [pk]
  tenant_id UUID [ref: > tenants.id]
  name varchar(255)
  
  created_at timestamp
  updated_at timestamp
}

Table sink_tags {
  sink_id UUID [ref: > sinks.id]
  key varchar(255)
  value varchar(255)
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (sink_id, key) [pk]
  }
}

Table sink_app_configs {
  sink_id UUID [ref: > sinks.id]
  key varchar(255)
  value varchar(255)
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (sink_id, key) [pk]
  }
}

Table sink_kc_connectors {
  id UUID [pk]
  sink_id UUID [ref: > sinks.id]
  name varchar(255) [not null, unique]
  connector_class varchar(255)
  version varchar(255)

  created_at timestamp
  updated_at timestamp
}

Table sink_kc_configs {
  kc_id UUID [ref: > sink_kc_connectors.id]
  key varchar(255)
  value text
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (kc_id, key) [pk]
  }
}

Table pipelines {
  id UUID [pk]
  tenant_id UUID [ref: > tenants.id]
  source_id UUID [ref: > sources.id]
  sink_id UUID [ref: > sinks.id]
  name varchar(255)
  
  created_at timestamp
  updated_at timestamp
}

Table pipeline_tags {
  pipeline_id int [ref: > pipelines.id]
  key varchar(255)
  value varchar(255)
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (pipeline_id, key) [pk]
  }
}

Table pipeline_app_configs {
  pipeline_id UUID [ref: > pipelines.id]
  key varchar(255)
  value varchar(255)
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (pipeline_id, key) [pk]
  }
}

Table pipeline_source_app_tables {
  pipeline_id UUID [ref: > pipelines.id]
  table_id UUID [ref: > source_app_tables.id]
  
  created_at timestamp
  updated_at timestamp

  indexes {
    (pipeline_id, table_id) [pk]
  }
}
